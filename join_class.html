<!DOCTYPE html>
<html>
<head>
  <title>Join Live Class</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js"></script>
  <style>
    .join-container { display: flex; max-width: 1100px; margin: 3rem auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 24px rgba(100,100,255,0.10); }
    .video-section { flex: 2; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); }
    .info-section { flex: 1; padding: 2.5rem 2rem; border-left: 1.5px solid #eee; display: flex; flex-direction: column; justify-content: flex-start; background: #fff; }
    .video-player { width: 100%; max-width: 640px; height: 360px; background: #000; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 1.5rem; }
    .class-info { width: 100%; max-width: 640px; text-align: left; }
    .class-title { font-size: 1.5rem; font-weight: 600; color: #232946; margin-bottom: 0.5rem; }
    .class-description { color: #666; line-height: 1.5; margin-bottom: 1rem; }
    .back-link { color: #6a82fb; text-decoration: none; font-weight: 500; }
    .back-link:hover { text-decoration: underline; }
    .chat-card { margin-top:1rem; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%); border-radius:12px; box-shadow: 0 4px 16px rgba(100,100,255,0.08); padding:2rem 1.5rem 1.2rem 1.5rem; max-height:520px; min-height:340px; display:flex; flex-direction:column; border: 1px solid #e0e7ff; }
    .chat-messages { flex:1; overflow-y:auto; min-height:220px; max-height:340px; margin-bottom:1.2rem; border-bottom:1px solid #e0e7ff; padding-bottom:0.7rem; font-size:1.08rem; }
    .chat-input { flex:1; border-radius:8px; border:1px solid #e0e7ff; padding:0.5rem 0.8rem; background: #fff; }
    .chat-input:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .chat-send-btn { border-radius:8px; background: linear-gradient(135deg, #6a82fb 0%, #5a6fd8 100%); border: none; color: #fff; padding: 0.5rem 1rem; cursor: pointer; transition: all 0.2s; }
    .chat-send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(106,130,251,0.3); }
    .chat-message { margin: 0.3rem 0; padding: 0.4rem 0.7rem; background: #fff; border-radius: 7px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 3px solid #6a82fb; }
    @media (max-width: 900px) {
      .join-container { flex-direction: column; }
      .info-section { border-left: none; border-top: 1.5px solid #eee; }
      .video-section, .info-section { padding: 1.2rem; }
    }
    
    /* Dark Mode Styles */
    body.dark-mode {
      background: #1a1a2e;
      color: #fff;
    }
    
    body.dark-mode .join-container {
      background: #232946;
      box-shadow: 0 4px 24px rgba(100,100,255,0.20);
    }
    
    body.dark-mode .video-section {
      background: linear-gradient(135deg, #232946 0%, #1a1a2e 100%);
    }
    
    body.dark-mode .info-section {
      background: #232946;
      border-left-color: #2a2a3a;
    }
    
    body.dark-mode .class-title {
      color: #fff;
    }
    
    body.dark-mode .class-description {
      color: #b8c5d6;
    }
    
    body.dark-mode .chat-card {
      background: linear-gradient(135deg, #2a2a3a 0%, #1a1a2e 100%);
      border-color: #3a3a4a;
    }
    
    body.dark-mode .chat-input {
      background: #1a1a2e;
      border-color: #3a3a4a;
      color: #fff;
    }
    
    body.dark-mode .chat-input:focus {
      border-color: #6a82fb;
    }
    
    body.dark-mode .chat-message {
      background: #1a1a2e;
      border-left-color: #6a82fb;
    }
    
    body.dark-mode .tab-btn {
      color: #b8c5d6;
    }
    
    body.dark-mode .tab-btn.active {
      color: #6a82fb;
      border-bottom-color: #6a82fb;
    }
    
    body.dark-mode .tab-container {
      border-bottom-color: #3a3a4a;
    }
    .live-watch-container { width: 100%; max-width: 680px; background: #fff; border: 1px solid #e0e7ff; border-radius: 12px; box-shadow: 0 6px 24px rgba(100,100,255,0.12); padding: 0.8rem; margin-bottom: 1.5rem; }
    body.dark-mode .live-watch-container { background: #232946; border-color: #3a3a4a; box-shadow: 0 6px 24px rgba(0,0,0,0.3); }
    
    /* Device Selection Styles for Student View */
    .device-selection { margin-top: 1rem; padding: 1rem; background: rgba(106,130,251,0.03); border-radius: 12px; border: 1px solid #e0e7ff; }
    .device-row { display: flex; gap: 1rem; margin-bottom: 0.8rem; align-items: center; }
    .device-row:last-child { margin-bottom: 0; }
    .device-label { min-width: 80px; font-weight: 500; color: #232946; font-size: 0.9rem; }
    .device-select { flex: 1; padding: 0.6rem 0.8rem; border: 1px solid #e0e7ff; border-radius: 8px; background: #fff; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
    .device-select:focus { outline: none; border-color: #6a82fb; box-shadow: 0 0 0 2px rgba(106,130,251,0.1); }
    .device-select:hover { border-color: #b8c5d6; }
    .device-icon { width: 20px; height: 20px; color: #6a82fb; }
    .device-status { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Dark mode device selection */
    body.dark-mode .device-selection { background: rgba(35,41,70,0.2); border-color: #3a3a4a; }
    body.dark-mode .device-label { color: #e0e7ff; }
    body.dark-mode .device-select { background: #232946; border-color: #3a3a4a; color: #fff; }
    body.dark-mode .device-select:focus { border-color: #6a82fb; }
    body.dark-mode .device-status { color: #b8c5d6; }
  </style>
</head>
<body>
  <div class="join-container">
    <div class="video-section">
      <h3 style="color:#6a82fb; margin-bottom:1rem;">Live Class (Student View)</h3>
      
      <!-- Universal Video Container for Students -->
      <div class="live-watch-container">
        <!-- Host Live Camera Feed (when available) -->
        <video id="hostCameraFeed" class="video-player" autoplay playsinline style="display: none; margin-bottom: 1rem;"></video>
        
        <!-- Content Video (YouTube or uploaded video) -->
        <div id="contentVideo" style="display: block;">
          {% set is_youtube = 'youtube.com' in meeting_url or 'youtu.be' in meeting_url %}
          {% if is_youtube %}
            {% set youtube_id = None %}
            {% if 'youtu.be' in meeting_url %}
              {% set youtube_id = meeting_url.split('/')[-1].split('?')[0] %}
            {% elif 'youtube.com' in meeting_url and 'v=' in meeting_url %}
              {% set youtube_id = meeting_url.split('v=')[1].split('&')[0] %}
            {% endif %}
            {% if youtube_id %}
              <iframe class="video-player" width="640" height="360" src="https://www.youtube.com/embed/{{ youtube_id }}" frameborder="0" allowfullscreen></iframe>
            {% else %}
              <div class="video-player" style="display:flex;align-items:center;justify-content:center;color:#888;">Invalid YouTube Link</div>
            {% endif %}
          {% else %}
            <video class="video-player" controls>
              <source src="{{ meeting_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
        
        <!-- Live Class Status -->
        <div id="liveStatus" style="margin-top: 1rem; text-align: center; padding: 1rem; background: rgba(106,130,251,0.05); border-radius: 12px; border: 1px solid #e0e7ff;">
          <span id="liveStatusText" style="color: #6a82fb; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
            </svg>
            Watching content video
          </span>
        </div>
        
        <!-- Device Selection for Student -->
        <div class="device-selection" style="display: none;" id="studentDeviceSelection">
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
            <label class="device-label">Camera:</label>
            <select id="studentVideoSelect" class="device-select">
              <option value="">Select Camera...</option>
            </select>
          </div>
          <div class="device-row">
            <svg class="device-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </svg>
            <label class="device-label">Microphone:</label>
            <select id="studentAudioSelect" class="device-select">
              <option value="">Select Microphone...</option>
            </select>
          </div>
          <div class="device-status" id="studentDeviceStatus">
            📱 Select your devices for participation
          </div>
        </div>
      </div>
      <div class="class-info">
        <h2 class="class-title">{{ topic or 'Live Class' }}</h2>
        <p class="class-description">{{ description or '' }}</p>
        <a href="/online-class" class="back-link">&larr; Back to Online Classes</a>
      </div>
    </div>
    <div class="info-section">
      <div class="tab-container" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e7ff;">
        <button class="tab-btn active" onclick="showTab('chat')">Chat</button>
        <button class="tab-btn" onclick="showTab('polls')">Polls</button>
        <button class="tab-btn" onclick="showTab('doubts')">Doubts</button>
        <button id="darkModeToggle" class="btn btn-primary" style="min-width:160px;">Toggle Dark Mode</button>
      </div>
      <!-- Chat Tab -->
      <div id="chat-tab" class="tab-content active">
        <div class="chat-card">
          <div id="chatMessages" class="chat-messages">
            <!-- Chat messages will appear here -->
          </div>
          <form id="chatForm" style="display:flex; gap:0.5rem;">
            <input type="text" id="chatInput" placeholder="Type a message..." class="chat-input" autocomplete="off" />
            <button type="submit" class="chat-send-btn">Send</button>
          </form>
        </div>
      </div>
      <!-- Polls Tab -->
      <div id="polls-tab" class="tab-content">
        <div class="poll-section">
          <h3 style="margin-bottom: 1rem; color: #fc5c7d;">Active Polls</h3>
          <div id="activePolls">
            <div class="poll-item" style="background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border: 1px solid #ffd6d6;">
              <div class="poll-question" style="font-weight:600;">(Sample) Which topic do you want next?</div>
              <div class="poll-options">
                <label><input type="radio" name="poll1"> Algebra</label><br>
                <label><input type="radio" name="poll1"> Geometry</label><br>
                <label><input type="radio" name="poll1"> Trigonometry</label>
              </div>
              <button class="poll-btn" style="margin-top:0.5rem;">Vote</button>
            </div>
          </div>
          <div style="margin-top:1rem; color:#888; font-size:0.95rem;">Polls created by the host will appear here.</div>
        </div>
      </div>
      <!-- Doubts Tab -->
      <div id="doubts-tab" class="tab-content">
        <div class="doubts-section">
          <h3 style="margin-bottom: 1rem; color: #48bb78;">Ask a Doubt</h3>
          <form id="doubtForm" style="margin-bottom:1rem;">
            <input type="text" id="doubtInput" placeholder="Type your doubt..." class="poll-input" required style="width:100%; margin-bottom:0.5rem;" />
            <button type="submit" class="poll-btn">Submit Doubt</button>
          </form>
          <div id="doubtsList">
            <!-- Doubts will appear here -->
            <div class="doubt-item" style="background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78;">
              <div class="doubt-user">You</div>
              <div class="doubt-text">(Sample) How to solve quadratic equations?</div>
            </div>
          </div>
          <div style="margin-top:1rem; color:#888; font-size:0.95rem;">Your doubts will be visible to the host.</div>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// Get class ID from URL
const classId = window.location.pathname.split('/').pop();

// Enhanced Socket.IO connection with reconnection
const socket = io({
  timeout: 10000,
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  maxReconnectionAttempts: 10,
  forceNew: true
});

const room = 'liveclass_' + classId;
let isConnected = false;
let reconnectAttempts = 0;

// Connection management
socket.on('connect', () => {
  console.log('Connected to server:', socket.id);
  isConnected = true;
  reconnectAttempts = 0;
  
  // Join the room
  socket.emit('join-room', { room });
});

socket.on('disconnect', (reason) => {
  console.log('Disconnected from server:', reason);
  isConnected = false;
});

socket.on('connect_error', (error) => {
  console.error('Connection error:', error);
  reconnectAttempts++;
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Reconnecting... (${reconnectAttempts}/10)
    `;
    statusEl.style.color = '#ffa726';
  }
});

socket.on('reconnect', (attemptNumber) => {
  console.log('Reconnected after', attemptNumber, 'attempts');
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
      </svg>
      Reconnected to live class
    `;
    statusEl.style.color = '#48bb78';
  }
});

socket.on('reconnect_failed', () => {
  console.error('Failed to reconnect after maximum attempts');
  
  const statusEl = document.getElementById('liveStatusText');
  if (statusEl) {
    statusEl.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
      </svg>
      Connection lost - Please refresh
    `;
    statusEl.style.color = '#fc5c7d';
  }
});

// Error handling
socket.on('error', (data) => {
  console.error('Socket error:', data);
});

// Room management
socket.on('joined-room', (data) => {
  console.log('Joined room:', data.room);
});

// Live Camera Stream Variables
const hostCameraFeed = document.getElementById('hostCameraFeed');
const contentVideo = document.getElementById('contentVideo');
const liveStatusText = document.getElementById('liveStatusText');

// Student Device Selection Variables
const studentDeviceSelection = document.getElementById('studentDeviceSelection');
const studentVideoSelect = document.getElementById('studentVideoSelect');
const studentAudioSelect = document.getElementById('studentAudioSelect');
const studentDeviceStatus = document.getElementById('studentDeviceStatus');
let studentDevices = { videoInputs: [], audioInputs: [] };
let selectedStudentVideo = null;
let selectedStudentAudio = null;

// Listen for host camera status updates
socket.on('host_camera_status', (data) => {
  if (data.class_id === classId) {
    if (data.status === 'live') {
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="8" fill="#ff4444"/>
          <circle cx="12" cy="12" r="4" fill="#fff"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#48bb78';
    } else {
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#666';
    }
  }
});

// Listen for host video mode changes
socket.on('host_video_mode', (data) => {
  if (data.class_id === classId) {
    if (data.mode === 'camera') {
      // For now, we show a message that host is using camera
      // In full WebRTC implementation, this would show the actual camera stream
      hostCameraFeed.style.display = 'none'; // Will be 'block' when WebRTC is implemented
      contentVideo.style.display = 'block';
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
        </svg>
        ${data.message} (WebRTC implementation pending)
      `;
      liveStatusText.style.color = '#fc5c7d';
    } else {
      hostCameraFeed.style.display = 'none';
      contentVideo.style.display = 'block';
      liveStatusText.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14z"/>
        </svg>
        ${data.message}
      `;
      liveStatusText.style.color = '#6a82fb';
    }
  }
});

// Listen for host microphone status
socket.on('host_mic_status', (data) => {
  if (data.class_id === classId) {
    const micStatus = data.muted ? '🔇 Host microphone muted' : '🎤 Host microphone active';
    // You could show this in a toast notification or update the status
    console.log(micStatus);
  }
});

// Student Device Management Functions
async function enumerateStudentDevices() {
  try {
    // Request permission first
    await navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        stream.getTracks().forEach(track => track.stop());
      });

    const devices = await navigator.mediaDevices.enumerateDevices();
    studentDevices.videoInputs = devices.filter(device => device.kind === 'videoinput');
    studentDevices.audioInputs = devices.filter(device => device.kind === 'audioinput');
    
    populateStudentDeviceSelectors();
    studentDeviceStatus.innerHTML = `📱 Found ${studentDevices.videoInputs.length} camera(s) and ${studentDevices.audioInputs.length} microphone(s)`;
    
    // Show device selection if devices are available
    if (studentDevices.videoInputs.length > 0 || studentDevices.audioInputs.length > 0) {
      studentDeviceSelection.style.display = 'block';
    }
    
    console.log('Student devices enumerated:', studentDevices);
  } catch (error) {
    console.error('Error enumerating student devices:', error);
    studentDeviceStatus.innerHTML = '❌ Could not access media devices. Check permissions to participate.';
  }
}

function populateStudentDeviceSelectors() {
  // Populate video sources
  studentVideoSelect.innerHTML = '<option value="">Select Camera...</option>';
  studentDevices.videoInputs.forEach((device, index) => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `Camera ${index + 1}`;
    studentVideoSelect.appendChild(option);
  });

  // Populate audio sources
  studentAudioSelect.innerHTML = '<option value="">Select Microphone...</option>';
  studentDevices.audioInputs.forEach((device, index) => {
    const option = document.createElement('option');
    option.value = device.deviceId;
    option.textContent = device.label || `Microphone ${index + 1}`;
    studentAudioSelect.appendChild(option);
  });

  // Set default selections if available
  if (studentDevices.videoInputs.length > 0) {
    selectedStudentVideo = studentDevices.videoInputs[0].deviceId;
    studentVideoSelect.value = selectedStudentVideo;
  }
  if (studentDevices.audioInputs.length > 0) {
    selectedStudentAudio = studentDevices.audioInputs[0].deviceId;
    studentAudioSelect.value = selectedStudentAudio;
  }
  
  // Initial status update
  handleStudentDeviceSelection();
}

function handleStudentDeviceSelection() {
  selectedStudentVideo = studentVideoSelect.value;
  selectedStudentAudio = studentAudioSelect.value;
  
  const videoDeviceName = studentVideoSelect.options[studentVideoSelect.selectedIndex]?.text || 'None';
  const audioDeviceName = studentAudioSelect.options[studentAudioSelect.selectedIndex]?.text || 'None';
  
  studentDeviceStatus.innerHTML = `🎯 Ready with: ${videoDeviceName} & ${audioDeviceName}`;
  
  // Store selections for potential future use (like breakout rooms, participation, etc.)
  localStorage.setItem('selectedStudentVideo', selectedStudentVideo || '');
  localStorage.setItem('selectedStudentAudio', selectedStudentAudio || '');
}

// Add event listeners for student device selection
if (studentVideoSelect && studentAudioSelect) {
  studentVideoSelect.addEventListener('change', handleStudentDeviceSelection);
  studentAudioSelect.addEventListener('change', handleStudentDeviceSelection);
}

// Initialize student device enumeration
enumerateStudentDevices();

// --- Polls ---
function renderPolls(polls) {
  const pollsContainer = document.getElementById('activePolls');
  pollsContainer.innerHTML = '';
  polls.forEach(poll => {
    const pollDiv = document.createElement('div');
    pollDiv.className = 'poll-item';
    pollDiv.innerHTML = `
      <div class="poll-question" style="font-weight:600;">${poll.question}</div>
      <div class="poll-options">
        ${poll.options.map(opt => `<label><input type="radio" name="poll${poll.id}" value="${opt.id}"> ${opt.option_text} <span class='poll-votes' id='poll-votes-${opt.id}'>0</span></label><br>`).join('')}
      </div>
      <button class="poll-btn" style="margin-top:0.5rem;" onclick="votePoll(${poll.id})">Vote</button>
    `;
    pollsContainer.appendChild(pollDiv);
  });
}
function votePoll(pollId) {
  const selected = document.querySelector(`input[name='poll${pollId}']:checked`);
  if (!selected) return alert('Select an option!');
  const optionId = selected.value;
  // Use localStorage to prevent double voting (client-side only, server also checks)
  if (localStorage.getItem('voted_poll_' + pollId)) return alert('You already voted!');
  socket.emit('vote_poll', { poll_id: pollId, option_id: optionId, user_id: getUserId(), class_id: classId });
  localStorage.setItem('voted_poll_' + pollId, '1');
}
socket.on('new_poll', poll => {
  socket.emit('get_polls_and_doubts', { class_id: classId });
});
socket.on('poll_results', data => {
  if (data && data.results) {
    data.results.forEach(opt => {
      const el = document.getElementById('poll-votes-' + opt.option_id);
      if (el) el.textContent = `(${opt.votes} votes)`;
    });
  }
});

// --- Doubts ---
function renderDoubts(doubts) {
  const doubtsList = document.getElementById('doubtsList');
  doubtsList.innerHTML = '';
  doubts.forEach(doubt => {
    const div = document.createElement('div');
    div.className = 'doubt-item';
    div.style = 'background: #fff; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; border-left: 3px solid #48bb78;';
    div.innerHTML = `<div class="doubt-user">${doubt.username}</div><div class="doubt-text">${doubt.doubt_text}</div>` +
      (doubt.status === 'resolved' ? '<div style="color:#48bb78;font-weight:600;">✓ Resolved</div>' : doubt.status === 'ignored' ? '<div style="color:#a0aec0;">Ignored</div>' : '');
    doubtsList.appendChild(div);
  });
}
document.getElementById('doubtForm').onsubmit = function(e) {
  e.preventDefault();
  var doubtInput = document.getElementById('doubtInput');
  var text = doubtInput.value.trim();
  if (!text) return;
  socket.emit('submit_doubt', { class_id: classId, user_id: getUserId(), username: getUsername(), doubt_text: text });
  doubtInput.value = '';
};
socket.on('update_doubts', data => {
  renderDoubts(data.doubts);
});

// Initial fetch of polls and doubts
socket.emit('get_polls_and_doubts', { class_id: classId });
socket.on('init_polls_and_doubts', data => {
  renderPolls(data.polls);
  renderDoubts(data.doubts);
});

// --- Helpers ---
function getUserId() {
  // Use a cookie, session, or fallback to random for demo
  if (window.username) return window.username;
  let id = localStorage.getItem('user_id');
  if (!id) { id = 'user_' + Math.random().toString(36).substr(2, 8); localStorage.setItem('user_id', id); }
  return id;
}
function getUsername() {
  // Use a cookie, session, or fallback to 'Student'
  return window.username || 'Student';
}

// --- Tab switching logic ---
function showTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  event.target.classList.add('active');
}
</script>
</body>
</html> 